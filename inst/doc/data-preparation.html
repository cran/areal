<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />

<meta name="author" content="Christopher Prener, Ph.D." />

<meta name="date" content="2020-07-23" />

<title>Preparing Data for Interpolation</title>

<script>// Hide empty <a> tag within highlighted CodeBlock for screen reader accessibility (see https://github.com/jgm/pandoc/issues/6352#issuecomment-626106786) -->
// v0.0.1
// Written by JooYoung Seo (jooyoung@psu.edu) and Atsushi Yasumoto on June 1st, 2020.

document.addEventListener('DOMContentLoaded', function() {
  const codeList = document.getElementsByClassName("sourceCode");
  for (var i = 0; i < codeList.length; i++) {
    var linkList = codeList[i].getElementsByTagName('a');
    for (var j = 0; j < linkList.length; j++) {
      if (linkList[j].innerHTML === "") {
        linkList[j].setAttribute('aria-hidden', 'true');
      }
    }
  }
});
</script>


<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
code.sourceCode > span { display: inline-block; line-height: 1.25; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>



<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Preparing Data for Interpolation</h1>
<h4 class="author">Christopher Prener, Ph.D.</h4>
<h4 class="date">2020-07-23</h4>



<p>Depending on the state of your spatial data, they may require some cleaning and modification before interpolation. The types of issues to address pre-interpolation fall into a few distinct categories:</p>
<ol style="list-style-type: decimal">
<li>Data are not in the right format</li>
<li>Data are not in the right coordinate system</li>
<li>Data have variable name conflicts</li>
<li>Data have too many variables or observations and therefore must be subset</li>
</ol>
<p>Each of these conditions will be discussed below. The following examples assume:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="kw">library</span>(areal)</span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="kw">library</span>(dplyr)   <span class="co"># data wrangling</span></span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="kw">library</span>(sf)      <span class="co"># spatial data operations</span></span>
<span id="cb1-4"><a href="#cb1-4"></a></span>
<span id="cb1-5"><a href="#cb1-5"></a><span class="co"># load data into enviornment</span></span>
<span id="cb1-6"><a href="#cb1-6"></a>race &lt;-<span class="st"> </span>ar_stl_race</span>
<span id="cb1-7"><a href="#cb1-7"></a>asthma &lt;-<span class="st"> </span>ar_stl_asthma</span>
<span id="cb1-8"><a href="#cb1-8"></a>wards &lt;-<span class="st"> </span>ar_stl_wards</span>
<span id="cb1-9"><a href="#cb1-9"></a></span>
<span id="cb1-10"><a href="#cb1-10"></a><span class="co"># create example data - non-spatial data</span></span>
<span id="cb1-11"><a href="#cb1-11"></a>asthmaTbl &lt;-<span class="st"> </span>ar_stl_asthma</span>
<span id="cb1-12"><a href="#cb1-12"></a><span class="kw">st_geometry</span>(asthmaTbl) &lt;-<span class="st"> </span><span class="ot">NULL</span></span>
<span id="cb1-13"><a href="#cb1-13"></a></span>
<span id="cb1-14"><a href="#cb1-14"></a><span class="co"># create example data - wrong crs</span></span>
<span id="cb1-15"><a href="#cb1-15"></a>race83 &lt;-<span class="st"> </span><span class="kw">st_transform</span>(race, <span class="dt">crs =</span> <span class="dv">4269</span>)</span></code></pre></div>
<div id="validating-data" class="section level2">
<h2>Validating Data</h2>
<p><code>areal</code> has a built-in tool for data validation, <code>ar_validate()</code>, that provides an excellent starting place for ensuring your data are ready to interpolate. The validation process covers the first three issues listed in the introduction. It can be run in a simple format:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a><span class="kw">ar_validate</span>(<span class="dt">source =</span> asthma, <span class="dt">target =</span> wards, <span class="dt">varList =</span> <span class="st">&quot;ASTHMA&quot;</span>, <span class="dt">method =</span> <span class="st">&quot;aw&quot;</span>)</span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="co">#&gt; [1] TRUE</span></span></code></pre></div>
<p>If <code>ar_validate()</code> returns a <code>FALSE</code> value, it can also be run in a verbose manner that returns a detailed tibble:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a><span class="kw">ar_validate</span>(<span class="dt">source =</span> asthma, <span class="dt">target =</span> wards, <span class="dt">varList =</span> <span class="st">&quot;ASTHMA&quot;</span>, <span class="dt">method =</span> <span class="st">&quot;aw&quot;</span>, <span class="dt">verbose =</span> <span class="ot">TRUE</span>)</span>
<span id="cb3-2"><a href="#cb3-2"></a><span class="co">#&gt; # A tibble: 6 x 2</span></span>
<span id="cb3-3"><a href="#cb3-3"></a><span class="co">#&gt;   test                            result</span></span>
<span id="cb3-4"><a href="#cb3-4"></a><span class="co">#&gt;   &lt;chr&gt;                           &lt;lgl&gt; </span></span>
<span id="cb3-5"><a href="#cb3-5"></a><span class="co">#&gt; 1 sf Objects                      TRUE  </span></span>
<span id="cb3-6"><a href="#cb3-6"></a><span class="co">#&gt; 2 CRS Match                       TRUE  </span></span>
<span id="cb3-7"><a href="#cb3-7"></a><span class="co">#&gt; 3 CRS is Planar                   TRUE  </span></span>
<span id="cb3-8"><a href="#cb3-8"></a><span class="co">#&gt; 4 Variables Exist in Source       TRUE  </span></span>
<span id="cb3-9"><a href="#cb3-9"></a><span class="co">#&gt; 5 No Variable Conflicts in Target TRUE  </span></span>
<span id="cb3-10"><a href="#cb3-10"></a><span class="co">#&gt; 6 Overall Evaluation              TRUE</span></span></code></pre></div>
<p>Use the <code>verbose = TRUE</code> output as a checklist to address issues before interpolating your data.</p>
</div>
<div id="format-issues" class="section level2">
<h2>Format Issues</h2>
<p>Data need to be loaded as <code>sf</code> objects in <code>R</code>. If <code>ar_validate()</code> returns <code>FALSE</code> for the first condition, data are not stored as <code>sf</code> objects:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a><span class="kw">ar_validate</span>(<span class="dt">source =</span> asthmaTbl, <span class="dt">target =</span> wards, <span class="dt">varList =</span> <span class="st">&quot;ASTHMA&quot;</span>, <span class="dt">method =</span> <span class="st">&quot;aw&quot;</span>, <span class="dt">verbose =</span> <span class="ot">TRUE</span>)</span>
<span id="cb4-2"><a href="#cb4-2"></a><span class="co">#&gt; # A tibble: 6 x 2</span></span>
<span id="cb4-3"><a href="#cb4-3"></a><span class="co">#&gt;   test                            result</span></span>
<span id="cb4-4"><a href="#cb4-4"></a><span class="co">#&gt;   &lt;chr&gt;                           &lt;lgl&gt; </span></span>
<span id="cb4-5"><a href="#cb4-5"></a><span class="co">#&gt; 1 sf Objects                      FALSE </span></span>
<span id="cb4-6"><a href="#cb4-6"></a><span class="co">#&gt; 2 CRS Match                       NA    </span></span>
<span id="cb4-7"><a href="#cb4-7"></a><span class="co">#&gt; 3 CRS is Planar                   NA    </span></span>
<span id="cb4-8"><a href="#cb4-8"></a><span class="co">#&gt; 4 Variables Exist in Source       NA    </span></span>
<span id="cb4-9"><a href="#cb4-9"></a><span class="co">#&gt; 5 No Variable Conflicts in Target NA    </span></span>
<span id="cb4-10"><a href="#cb4-10"></a><span class="co">#&gt; 6 Overall Evaluation              FALSE</span></span></code></pre></div>
<div id="external-spatial-data" class="section level3">
<h3>External Spatial Data</h3>
<p>If you have external data, using <code>st_read()</code> is the best way to load them:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a>df &lt;-<span class="st"> </span>sf<span class="op">::</span><span class="kw">st_read</span>(<span class="st">&quot;data.shp&quot;</span>, <span class="dt">stringsAsFactors =</span> <span class="ot">FALSE</span>)</span></code></pre></div>
<p>The <code>st_read()</code> function supports a variety of the most common data sources.</p>
</div>
<div id="sp-data" class="section level3">
<h3>sp Data</h3>
<p>If you are working with data that is an <code>sp</code> object in <code>R</code>, the <code>sf</code> package has a function <code>st_as_sf()</code> can be used to convert the object to <code>sf</code>:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a>sf_object &lt;-<span class="st"> </span>sf<span class="op">::</span><span class="kw">st_as_sf</span>(sp_object)</span></code></pre></div>
</div>
<div id="data-from-tidycensus-and-tigris" class="section level3">
<h3>Data From tidycensus and tigris</h3>
<p>If you are using either the <a href="https://walkerke.github.io/tidycensus/"><code>tidycensus</code></a> or <a href="https://github.com/walkerke/tigris"><code>tigris</code></a> packages to access spatial data, there are options for downloading data as <code>sf</code> objects as well. In <code>tidycensus</code>, the <code>geometry = TRUE</code> option should be used. In <code>tigris</code>, the <code>class = &quot;sf&quot;</code> option should be used.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a>stl_race &lt;-<span class="st"> </span>tidycensus<span class="op">::</span><span class="kw">get_acs</span>(<span class="dt">geography =</span> <span class="st">&quot;tract&quot;</span>, <span class="dt">state =</span> <span class="dv">29</span>, <span class="dt">county =</span> <span class="dv">510</span>, <span class="dt">year =</span> <span class="dv">2017</span>, </span>
<span id="cb7-2"><a href="#cb7-2"></a>                                <span class="dt">table =</span> <span class="st">&quot;B02001&quot;</span>, <span class="dt">output =</span> <span class="st">&quot;wide&quot;</span>, <span class="dt">geometry =</span> <span class="ot">TRUE</span>)</span>
<span id="cb7-3"><a href="#cb7-3"></a>stl_tracts &lt;-<span class="st"> </span>tigris<span class="op">::</span><span class="kw">tracts</span>(<span class="dt">state =</span> <span class="dv">29</span>, <span class="dt">county =</span> <span class="dv">510</span>, <span class="dt">class =</span> <span class="st">&quot;sf&quot;</span>)</span></code></pre></div>
</div>
<div id="tabular-data" class="section level3">
<h3>Tabular Data</h3>
<p>If you have tabular data, you will need to merge them with a shapefile or other spatial data set that contains the geometry for the corresponding spatial features. For American users, a potentially common scenario here will be table of census geography (such as tracts) that lacks the geometry for those features. These can be downloaded using <a href="https://github.com/walkerke/tigris"><code>tigris</code></a> and then combined using <a href="https://dplyr.tidyverse.org"><code>dplyr</code></a>. The following example assumes the tract data contains an identification number column named <code>GEOID</code> with the appropriate tract identifiers for St. Louis:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a>stl_tracts &lt;-<span class="st"> </span>tigris<span class="op">::</span><span class="kw">tracts</span>(<span class="dt">state =</span> <span class="dv">29</span>, <span class="dt">county =</span> <span class="dv">510</span>, <span class="dt">class =</span> <span class="st">&quot;sf&quot;</span>)</span>
<span id="cb8-2"><a href="#cb8-2"></a></span>
<span id="cb8-3"><a href="#cb8-3"></a>tract_data &lt;-<span class="st"> </span>dplyr<span class="op">::</span><span class="kw">left_join</span>(stl_tracts, asthmaTBL, <span class="dt">by =</span> <span class="st">&quot;GEOID&quot;</span>)</span></code></pre></div>
</div>
</div>
<div id="coordinate-systems" class="section level2">
<h2>Coordinate Systems</h2>
<p>Two coordinate system rules are enforced by <code>ar_validate</code>: both the source and the target data must be in the same <a href="https://geocompr.robinlovelace.net/spatial-class.html#crs-intro">coordinate system</a> and that coordinate system must be a projected coordinate system. The <code>sf</code> package contains a function named <code>st_crs()</code> for previewing the current coordinate system of your data:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a><span class="kw">st_crs</span>(race83)</span>
<span id="cb9-2"><a href="#cb9-2"></a><span class="co">#&gt; Coordinate Reference System:</span></span>
<span id="cb9-3"><a href="#cb9-3"></a><span class="co">#&gt;   User input: EPSG:4269 </span></span>
<span id="cb9-4"><a href="#cb9-4"></a><span class="co">#&gt;   wkt:</span></span>
<span id="cb9-5"><a href="#cb9-5"></a><span class="co">#&gt; GEOGCRS[&quot;NAD83&quot;,</span></span>
<span id="cb9-6"><a href="#cb9-6"></a><span class="co">#&gt;     DATUM[&quot;North American Datum 1983&quot;,</span></span>
<span id="cb9-7"><a href="#cb9-7"></a><span class="co">#&gt;         ELLIPSOID[&quot;GRS 1980&quot;,6378137,298.257222101,</span></span>
<span id="cb9-8"><a href="#cb9-8"></a><span class="co">#&gt;             LENGTHUNIT[&quot;metre&quot;,1]]],</span></span>
<span id="cb9-9"><a href="#cb9-9"></a><span class="co">#&gt;     PRIMEM[&quot;Greenwich&quot;,0,</span></span>
<span id="cb9-10"><a href="#cb9-10"></a><span class="co">#&gt;         ANGLEUNIT[&quot;degree&quot;,0.0174532925199433]],</span></span>
<span id="cb9-11"><a href="#cb9-11"></a><span class="co">#&gt;     CS[ellipsoidal,2],</span></span>
<span id="cb9-12"><a href="#cb9-12"></a><span class="co">#&gt;         AXIS[&quot;geodetic latitude (Lat)&quot;,north,</span></span>
<span id="cb9-13"><a href="#cb9-13"></a><span class="co">#&gt;             ORDER[1],</span></span>
<span id="cb9-14"><a href="#cb9-14"></a><span class="co">#&gt;             ANGLEUNIT[&quot;degree&quot;,0.0174532925199433]],</span></span>
<span id="cb9-15"><a href="#cb9-15"></a><span class="co">#&gt;         AXIS[&quot;geodetic longitude (Lon)&quot;,east,</span></span>
<span id="cb9-16"><a href="#cb9-16"></a><span class="co">#&gt;             ORDER[2],</span></span>
<span id="cb9-17"><a href="#cb9-17"></a><span class="co">#&gt;             ANGLEUNIT[&quot;degree&quot;,0.0174532925199433]],</span></span>
<span id="cb9-18"><a href="#cb9-18"></a><span class="co">#&gt;     USAGE[</span></span>
<span id="cb9-19"><a href="#cb9-19"></a><span class="co">#&gt;         SCOPE[&quot;unknown&quot;],</span></span>
<span id="cb9-20"><a href="#cb9-20"></a><span class="co">#&gt;         AREA[&quot;North America - NAD83&quot;],</span></span>
<span id="cb9-21"><a href="#cb9-21"></a><span class="co">#&gt;         BBOX[14.92,167.65,86.46,-47.74]],</span></span>
<span id="cb9-22"><a href="#cb9-22"></a><span class="co">#&gt;     ID[&quot;EPSG&quot;,4269]]</span></span></code></pre></div>
<p>The <code>EPSG</code> value <code>4269</code> refers to a specific type of coordinate system known as as geographic coordinate system. These data use latitude-longitude values, which vary in length and thus cannot be used to calculate area (a key component of carrying out areal interpolations). These data would fail the <code>ar_validate()</code> process:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a><span class="kw">ar_validate</span>(<span class="dt">source =</span> race83, <span class="dt">target =</span> wards, <span class="dt">varList =</span> <span class="st">&quot;TOTAL_E&quot;</span>, <span class="dt">method =</span> <span class="st">&quot;aw&quot;</span>, <span class="dt">verbose =</span> <span class="ot">TRUE</span>)</span>
<span id="cb10-2"><a href="#cb10-2"></a><span class="co">#&gt; # A tibble: 6 x 2</span></span>
<span id="cb10-3"><a href="#cb10-3"></a><span class="co">#&gt;   test                            result</span></span>
<span id="cb10-4"><a href="#cb10-4"></a><span class="co">#&gt;   &lt;chr&gt;                           &lt;lgl&gt; </span></span>
<span id="cb10-5"><a href="#cb10-5"></a><span class="co">#&gt; 1 sf Objects                      TRUE  </span></span>
<span id="cb10-6"><a href="#cb10-6"></a><span class="co">#&gt; 2 CRS Match                       FALSE </span></span>
<span id="cb10-7"><a href="#cb10-7"></a><span class="co">#&gt; 3 CRS is Planar                   FALSE </span></span>
<span id="cb10-8"><a href="#cb10-8"></a><span class="co">#&gt; 4 Variables Exist in Source       TRUE  </span></span>
<span id="cb10-9"><a href="#cb10-9"></a><span class="co">#&gt; 5 No Variable Conflicts in Target TRUE  </span></span>
<span id="cb10-10"><a href="#cb10-10"></a><span class="co">#&gt; 6 Overall Evaluation              FALSE</span></span></code></pre></div>
<p>These data fail both the matching CRS validation and the planar CRS validation because the <code>race</code> and <code>wards</code> data are in two different coordinate systems. We’ve already seen the CRS data for <code>race</code> above so we’ll look at the <code>CRS data for</code>wards`:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1"></a><span class="kw">st_crs</span>(wards)</span>
<span id="cb11-2"><a href="#cb11-2"></a><span class="co">#&gt; Coordinate Reference System:</span></span>
<span id="cb11-3"><a href="#cb11-3"></a><span class="co">#&gt;   User input: EPSG:26915 </span></span>
<span id="cb11-4"><a href="#cb11-4"></a><span class="co">#&gt;   wkt:</span></span>
<span id="cb11-5"><a href="#cb11-5"></a><span class="co">#&gt; PROJCRS[&quot;NAD83 / UTM zone 15N&quot;,</span></span>
<span id="cb11-6"><a href="#cb11-6"></a><span class="co">#&gt;     BASEGEOGCRS[&quot;NAD83&quot;,</span></span>
<span id="cb11-7"><a href="#cb11-7"></a><span class="co">#&gt;         DATUM[&quot;North American Datum 1983&quot;,</span></span>
<span id="cb11-8"><a href="#cb11-8"></a><span class="co">#&gt;             ELLIPSOID[&quot;GRS 1980&quot;,6378137,298.257222101,</span></span>
<span id="cb11-9"><a href="#cb11-9"></a><span class="co">#&gt;                 LENGTHUNIT[&quot;metre&quot;,1]]],</span></span>
<span id="cb11-10"><a href="#cb11-10"></a><span class="co">#&gt;         PRIMEM[&quot;Greenwich&quot;,0,</span></span>
<span id="cb11-11"><a href="#cb11-11"></a><span class="co">#&gt;             ANGLEUNIT[&quot;degree&quot;,0.0174532925199433]],</span></span>
<span id="cb11-12"><a href="#cb11-12"></a><span class="co">#&gt;         ID[&quot;EPSG&quot;,4269]],</span></span>
<span id="cb11-13"><a href="#cb11-13"></a><span class="co">#&gt;     CONVERSION[&quot;UTM zone 15N&quot;,</span></span>
<span id="cb11-14"><a href="#cb11-14"></a><span class="co">#&gt;         METHOD[&quot;Transverse Mercator&quot;,</span></span>
<span id="cb11-15"><a href="#cb11-15"></a><span class="co">#&gt;             ID[&quot;EPSG&quot;,9807]],</span></span>
<span id="cb11-16"><a href="#cb11-16"></a><span class="co">#&gt;         PARAMETER[&quot;Latitude of natural origin&quot;,0,</span></span>
<span id="cb11-17"><a href="#cb11-17"></a><span class="co">#&gt;             ANGLEUNIT[&quot;degree&quot;,0.0174532925199433],</span></span>
<span id="cb11-18"><a href="#cb11-18"></a><span class="co">#&gt;             ID[&quot;EPSG&quot;,8801]],</span></span>
<span id="cb11-19"><a href="#cb11-19"></a><span class="co">#&gt;         PARAMETER[&quot;Longitude of natural origin&quot;,-93,</span></span>
<span id="cb11-20"><a href="#cb11-20"></a><span class="co">#&gt;             ANGLEUNIT[&quot;degree&quot;,0.0174532925199433],</span></span>
<span id="cb11-21"><a href="#cb11-21"></a><span class="co">#&gt;             ID[&quot;EPSG&quot;,8802]],</span></span>
<span id="cb11-22"><a href="#cb11-22"></a><span class="co">#&gt;         PARAMETER[&quot;Scale factor at natural origin&quot;,0.9996,</span></span>
<span id="cb11-23"><a href="#cb11-23"></a><span class="co">#&gt;             SCALEUNIT[&quot;unity&quot;,1],</span></span>
<span id="cb11-24"><a href="#cb11-24"></a><span class="co">#&gt;             ID[&quot;EPSG&quot;,8805]],</span></span>
<span id="cb11-25"><a href="#cb11-25"></a><span class="co">#&gt;         PARAMETER[&quot;False easting&quot;,500000,</span></span>
<span id="cb11-26"><a href="#cb11-26"></a><span class="co">#&gt;             LENGTHUNIT[&quot;metre&quot;,1],</span></span>
<span id="cb11-27"><a href="#cb11-27"></a><span class="co">#&gt;             ID[&quot;EPSG&quot;,8806]],</span></span>
<span id="cb11-28"><a href="#cb11-28"></a><span class="co">#&gt;         PARAMETER[&quot;False northing&quot;,0,</span></span>
<span id="cb11-29"><a href="#cb11-29"></a><span class="co">#&gt;             LENGTHUNIT[&quot;metre&quot;,1],</span></span>
<span id="cb11-30"><a href="#cb11-30"></a><span class="co">#&gt;             ID[&quot;EPSG&quot;,8807]]],</span></span>
<span id="cb11-31"><a href="#cb11-31"></a><span class="co">#&gt;     CS[Cartesian,2],</span></span>
<span id="cb11-32"><a href="#cb11-32"></a><span class="co">#&gt;         AXIS[&quot;(E)&quot;,east,</span></span>
<span id="cb11-33"><a href="#cb11-33"></a><span class="co">#&gt;             ORDER[1],</span></span>
<span id="cb11-34"><a href="#cb11-34"></a><span class="co">#&gt;             LENGTHUNIT[&quot;metre&quot;,1]],</span></span>
<span id="cb11-35"><a href="#cb11-35"></a><span class="co">#&gt;         AXIS[&quot;(N)&quot;,north,</span></span>
<span id="cb11-36"><a href="#cb11-36"></a><span class="co">#&gt;             ORDER[2],</span></span>
<span id="cb11-37"><a href="#cb11-37"></a><span class="co">#&gt;             LENGTHUNIT[&quot;metre&quot;,1]],</span></span>
<span id="cb11-38"><a href="#cb11-38"></a><span class="co">#&gt;     USAGE[</span></span>
<span id="cb11-39"><a href="#cb11-39"></a><span class="co">#&gt;         SCOPE[&quot;unknown&quot;],</span></span>
<span id="cb11-40"><a href="#cb11-40"></a><span class="co">#&gt;         AREA[&quot;North America - 96°W to 90°W and NAD83 by country&quot;],</span></span>
<span id="cb11-41"><a href="#cb11-41"></a><span class="co">#&gt;         BBOX[25.61,-96,84,-90]],</span></span>
<span id="cb11-42"><a href="#cb11-42"></a><span class="co">#&gt;     ID[&quot;EPSG&quot;,26915]]</span></span></code></pre></div>
<p>If these data fail that process, <code>st_crs()</code> can be used to identify whether the source or the target (or both) are in an inappropriate coordinate system. The <code>EPSG</code> value <code>26915</code> refers to another type of coordinate system known as as projected coordinate system (or “planar” data). Further, <code>26915</code> is a particular type of projected coordinate system known as the <a href="https://en.wikipedia.org/wiki/Universal_Transverse_Mercator_coordinate_system">Universal Transverse Mercator</a> coordinate system. This is a good option for using <code>areal</code> because it is available around the world. There are a variety of tools for identifying the appropriate UTM zone, including this excellent <a href="https://mangomap.com/robertyoung/maps/69585/what-utm-zone-am-i-in-#">interactive map</a>. Once you have an EPSG zone, the website <a href="https://epsg.io">epsg.io</a> can be used to search for the appropriate <code>EPSG</code> value.</p>
<p>In this case, the <code>wards</code> data are in an appropriate system but the <code>race</code> data need to be transformed. The <code>st_transform()</code> function can be used to modify them to an appropriate coordinate system:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1"></a>raceFixed &lt;-<span class="st"> </span><span class="kw">st_transform</span>(race83, <span class="dt">crs =</span> <span class="dv">26915</span>)</span></code></pre></div>
<p>Once this is done, these data should pass the <code>ar_validate()</code> process:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1"></a><span class="kw">ar_validate</span>(<span class="dt">source =</span> raceFixed, <span class="dt">target =</span> wards, <span class="dt">varList =</span> <span class="st">&quot;TOTAL_E&quot;</span>, <span class="dt">method =</span> <span class="st">&quot;aw&quot;</span>, <span class="dt">verbose =</span> <span class="ot">TRUE</span>)</span>
<span id="cb13-2"><a href="#cb13-2"></a><span class="co">#&gt; # A tibble: 6 x 2</span></span>
<span id="cb13-3"><a href="#cb13-3"></a><span class="co">#&gt;   test                            result</span></span>
<span id="cb13-4"><a href="#cb13-4"></a><span class="co">#&gt;   &lt;chr&gt;                           &lt;lgl&gt; </span></span>
<span id="cb13-5"><a href="#cb13-5"></a><span class="co">#&gt; 1 sf Objects                      TRUE  </span></span>
<span id="cb13-6"><a href="#cb13-6"></a><span class="co">#&gt; 2 CRS Match                       TRUE  </span></span>
<span id="cb13-7"><a href="#cb13-7"></a><span class="co">#&gt; 3 CRS is Planar                   TRUE  </span></span>
<span id="cb13-8"><a href="#cb13-8"></a><span class="co">#&gt; 4 Variables Exist in Source       TRUE  </span></span>
<span id="cb13-9"><a href="#cb13-9"></a><span class="co">#&gt; 5 No Variable Conflicts in Target TRUE  </span></span>
<span id="cb13-10"><a href="#cb13-10"></a><span class="co">#&gt; 6 Overall Evaluation              TRUE</span></span></code></pre></div>
</div>
<div id="variable-conflicts" class="section level2">
<h2>Variable Conflicts</h2>
<p>If a variable does not exist in the source data, the validation process will fail:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1"></a><span class="kw">ar_validate</span>(<span class="dt">source =</span> race, <span class="dt">target =</span> wards, <span class="dt">varList =</span> <span class="st">&quot;TOTAL&quot;</span>, <span class="dt">method =</span> <span class="st">&quot;aw&quot;</span>, <span class="dt">verbose =</span> <span class="ot">TRUE</span>)</span>
<span id="cb14-2"><a href="#cb14-2"></a><span class="co">#&gt; # A tibble: 6 x 2</span></span>
<span id="cb14-3"><a href="#cb14-3"></a><span class="co">#&gt;   test                            result</span></span>
<span id="cb14-4"><a href="#cb14-4"></a><span class="co">#&gt;   &lt;chr&gt;                           &lt;lgl&gt; </span></span>
<span id="cb14-5"><a href="#cb14-5"></a><span class="co">#&gt; 1 sf Objects                      TRUE  </span></span>
<span id="cb14-6"><a href="#cb14-6"></a><span class="co">#&gt; 2 CRS Match                       TRUE  </span></span>
<span id="cb14-7"><a href="#cb14-7"></a><span class="co">#&gt; 3 CRS is Planar                   TRUE  </span></span>
<span id="cb14-8"><a href="#cb14-8"></a><span class="co">#&gt; 4 Variables Exist in Source       FALSE </span></span>
<span id="cb14-9"><a href="#cb14-9"></a><span class="co">#&gt; 5 No Variable Conflicts in Target TRUE  </span></span>
<span id="cb14-10"><a href="#cb14-10"></a><span class="co">#&gt; 6 Overall Evaluation              FALSE</span></span></code></pre></div>
<p>In this case, the fix is as easy as correcting the typo in our <code>ar_validate()</code> call - the variable <code>TOTAL</code> should really be <code>TOTAL_E</code>:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1"></a><span class="kw">names</span>(race)</span>
<span id="cb15-2"><a href="#cb15-2"></a><span class="co">#&gt;  [1] &quot;GEOID&quot;     &quot;STATEFP&quot;   &quot;COUNTYFP&quot;  &quot;TRACTCE&quot;   &quot;NAMELSAD&quot;  &quot;ALAND&quot;    </span></span>
<span id="cb15-3"><a href="#cb15-3"></a><span class="co">#&gt;  [7] &quot;AWATER&quot;    &quot;TOTAL_E&quot;   &quot;TOTAL_M&quot;   &quot;WHITE_E&quot;   &quot;WHITE_M&quot;   &quot;BLACK_E&quot;  </span></span>
<span id="cb15-4"><a href="#cb15-4"></a><span class="co">#&gt; [13] &quot;BLACK_M&quot;   &quot;AIAN_E&quot;    &quot;AIAN_M&quot;    &quot;ASIAN_E&quot;   &quot;ASIAN_M&quot;   &quot;NHPI_E&quot;   </span></span>
<span id="cb15-5"><a href="#cb15-5"></a><span class="co">#&gt; [19] &quot;NHPI_M&quot;    &quot;OTHER_E&quot;   &quot;OTHER_M&quot;   &quot;TWOPLUS_E&quot; &quot;TWOPLUS_M&quot; &quot;geometry&quot;</span></span></code></pre></div>
<p>Another common problem is that a variable exists in both our source and target data. For instance, we could add a <code>TOTAL_E</code> variable to our target data:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1"></a>wardsVar &lt;-<span class="st"> </span><span class="kw">mutate</span>(wards, <span class="dt">TOTAL_E =</span> <span class="kw">seq</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">28</span>))</span>
<span id="cb16-2"><a href="#cb16-2"></a></span>
<span id="cb16-3"><a href="#cb16-3"></a><span class="kw">ar_validate</span>(<span class="dt">source =</span> race, <span class="dt">target =</span> wardsVar, <span class="dt">varList =</span> <span class="st">&quot;TOTAL_E&quot;</span>, <span class="dt">method =</span> <span class="st">&quot;aw&quot;</span>, <span class="dt">verbose =</span> <span class="ot">TRUE</span>)</span>
<span id="cb16-4"><a href="#cb16-4"></a><span class="co">#&gt; # A tibble: 6 x 2</span></span>
<span id="cb16-5"><a href="#cb16-5"></a><span class="co">#&gt;   test                            result</span></span>
<span id="cb16-6"><a href="#cb16-6"></a><span class="co">#&gt;   &lt;chr&gt;                           &lt;lgl&gt; </span></span>
<span id="cb16-7"><a href="#cb16-7"></a><span class="co">#&gt; 1 sf Objects                      TRUE  </span></span>
<span id="cb16-8"><a href="#cb16-8"></a><span class="co">#&gt; 2 CRS Match                       TRUE  </span></span>
<span id="cb16-9"><a href="#cb16-9"></a><span class="co">#&gt; 3 CRS is Planar                   TRUE  </span></span>
<span id="cb16-10"><a href="#cb16-10"></a><span class="co">#&gt; 4 Variables Exist in Source       TRUE  </span></span>
<span id="cb16-11"><a href="#cb16-11"></a><span class="co">#&gt; 5 No Variable Conflicts in Target FALSE </span></span>
<span id="cb16-12"><a href="#cb16-12"></a><span class="co">#&gt; 6 Overall Evaluation              FALSE</span></span></code></pre></div>
<p>Now, we fail the validation process because there is a conflict between the source and target data - <code>TOTAL_E</code> exists in both data sets. We can use the <code>select()</code> function from <code>dplyr</code> to remove the offending variable from the target data before proceeding:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1"></a>wardsFixed &lt;-<span class="st"> </span><span class="kw">select</span>(wardsVar, <span class="op">-</span>TOTAL_E)</span>
<span id="cb17-2"><a href="#cb17-2"></a></span>
<span id="cb17-3"><a href="#cb17-3"></a><span class="kw">ar_validate</span>(<span class="dt">source =</span> race, <span class="dt">target =</span> wardsFixed, <span class="dt">varList =</span> <span class="st">&quot;TOTAL_E&quot;</span>, <span class="dt">method =</span> <span class="st">&quot;aw&quot;</span>, <span class="dt">verbose =</span> <span class="ot">TRUE</span>)</span>
<span id="cb17-4"><a href="#cb17-4"></a><span class="co">#&gt; # A tibble: 6 x 2</span></span>
<span id="cb17-5"><a href="#cb17-5"></a><span class="co">#&gt;   test                            result</span></span>
<span id="cb17-6"><a href="#cb17-6"></a><span class="co">#&gt;   &lt;chr&gt;                           &lt;lgl&gt; </span></span>
<span id="cb17-7"><a href="#cb17-7"></a><span class="co">#&gt; 1 sf Objects                      TRUE  </span></span>
<span id="cb17-8"><a href="#cb17-8"></a><span class="co">#&gt; 2 CRS Match                       TRUE  </span></span>
<span id="cb17-9"><a href="#cb17-9"></a><span class="co">#&gt; 3 CRS is Planar                   TRUE  </span></span>
<span id="cb17-10"><a href="#cb17-10"></a><span class="co">#&gt; 4 Variables Exist in Source       TRUE  </span></span>
<span id="cb17-11"><a href="#cb17-11"></a><span class="co">#&gt; 5 No Variable Conflicts in Target TRUE  </span></span>
<span id="cb17-12"><a href="#cb17-12"></a><span class="co">#&gt; 6 Overall Evaluation              TRUE</span></span></code></pre></div>
<p>Another option would be to rename the column using the <code>rename()</code> function from <code>dplyr</code> or by using another approach for renaming columns. Either option will work for <code>areal</code>’s purposes.</p>
</div>
<div id="subsetting" class="section level2">
<h2>Subsetting</h2>
<p>One cautionary note when using <code>areal</code> is that the validation process will not check to see if too many variables or observations exist in the data. Cleaning the data ahead of time so that only the relevant observations exist can help improve performance - if you have tract data for an entire state but only need a particular city, everything will go faster if you subset these data using the <code>filter()</code> function from <code>dplyr</code>:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1"></a>countyData &lt;-<span class="st"> </span><span class="kw">filter</span>(stateData, COUNTY <span class="op">==</span><span class="st"> </span><span class="dv">510</span>)</span></code></pre></div>
<p>Having too many columns poses an organizational problem more than anything else. We strongly encourage users to limit their interpolated data to only the needed values. For example, the <code>wards</code> data contains an <code>AREA</code> column whose units we don’t know and an <code>OBJECTID</code> column that is an artifact from its creation using an ESRI product:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1"></a><span class="kw">names</span>(wards)</span>
<span id="cb19-2"><a href="#cb19-2"></a><span class="co">#&gt; [1] &quot;OBJECTID&quot; &quot;WARD&quot;     &quot;AREA&quot;     &quot;geometry&quot;</span></span></code></pre></div>
<p>We can use the <code>select()</code> function from <code>dplyr</code> to remove these before interpolation since we don’t need them:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1"></a>wardsSubset &lt;-<span class="st"> </span><span class="kw">select</span>(wards, <span class="op">-</span>OBJECTID, <span class="op">-</span>AREA)</span></code></pre></div>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
